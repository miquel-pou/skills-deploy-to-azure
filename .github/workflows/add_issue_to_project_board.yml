name: Learning GitHub Script
on:
  issues:
    types: [opened]
jobs:
  comment:
    runs-on: ubuntu-latest
    steps:
    - name: Comment on new issue
      uses: actions/github-script@0.8.0
      with:
        github-token: ${{secrets.GITHUB_TOKEN}}
        script: |
            github.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: "üéâ You've created this issue comment using GitHub Script!!!"
            })

 # 1Ô∏è‚É£ Obtener ID del proyecto "Test Project"
    - name: Get project ID
      id: get_project
      uses: actions/github-script@0.8.0
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const projectName = 'Test Project';
            const owner = context.repo.owner;
            const issueNodeId = context.payload.issue.node_id;

            // 1Ô∏è‚É£ Buscar project + campo Status + opci√≥n Todo
            const query = `
              query ($login: String!) {
                user(login: $login) {
                  projectsV2(first: 20) {
                    nodes {
                      id
                      title
                      fields(first: 20) {
                        nodes {
                          ... on ProjectV2SingleSelectField {
                            id
                            name
                            options {
                              id
                              name
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            `;

            const { user } = await github.graphql(query, { login: owner });

            const project = user.projectsV2.nodes
              .find(p => p.title === projectName);
            if (!project) throw new Error('Project no encontrado');

            const status = project.fields.nodes
              .find(f => f.name === 'Status');
            if (!status) throw new Error('Campo Status no encontrado');

            const todo = status.options
              .find(o => o.name === 'Todo');
            if (!todo) throw new Error('Opci√≥n Todo no encontrada');

            // 2Ô∏è‚É£ A√±adir issue al project
            const addItem = `
              mutation ($projectId: ID!, $contentId: ID!) {
                addProjectV2ItemById(
                  input: { projectId: $projectId, contentId: $contentId }
                ) {
                  item { id }
                }
              }
            `;

            const { addProjectV2ItemById } = await github.graphql(addItem, {
              projectId: project.id,
              contentId: issueNodeId
            });

            // 3Ô∏è‚É£ Poner Status = Todo
            const setStatus = `
              mutation (
                $projectId: ID!,
                $itemId: ID!,
                $fieldId: ID!,
                $optionId: String!
              ) {
                updateProjectV2ItemFieldValue(
                  input: {
                    projectId: $projectId
                    itemId: $itemId
                    fieldId: $fieldId
                    value: { singleSelectOptionId: $optionId }
                  }
                ) {
                  projectV2Item { id }
                }
              }
            `;

            await github.graphql(setStatus, {
              projectId: project.id,
              itemId: addProjectV2ItemById.item.id,
              fieldId: status.id,
              optionId: todo.id
            });

            console.log('Issue a√±adida a Test Project con Status = Todo');
